name: Load Test

# =============================================================================
# Locust 부하 테스트
#
# 현재: 단일 노드 실행
# 분산 테스트 전환 시 코드 변경 없이 실행 방식만 변경하면 됨:
#
#   # Master 노드
#   locust -f locustfile.py --master --expect-workers=N
#
#   # Worker 노드들 (동일한 locustfile.py 사용)
#   locust -f locustfile.py --worker --master-host=<master-ip>
#
# CI에서 분산 테스트 예시:
#   locust --master --expect-workers=3 &
#   locust --worker --master-host=127.0.0.1 &
#   locust --worker --master-host=127.0.0.1 &
#   locust --worker --master-host=127.0.0.1 &
#   wait
# =============================================================================

on:
  # 스케줄 (매주 일요일 03:00 UTC = 한국시간 12:00)
  schedule:
    - cron: '0 3 * * 0'

# 환경변수로 설정 가능 (Repository Settings > Secrets and variables > Actions)
# 설정하지 않으면 기본값 사용
env:
  LOAD_TEST_USERS: ${{ vars.LOAD_TEST_USERS || '50' }}
  LOAD_TEST_SPAWN_RATE: ${{ vars.LOAD_TEST_SPAWN_RATE || '10' }}
  LOAD_TEST_DURATION: ${{ vars.LOAD_TEST_DURATION || '30s' }}

jobs:
  load-test:
    name: Locust Load Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install locust
      run: pip install -r tests/load/requirements.txt

    - name: Build and start services
      run: |
        docker compose up -d mysql redis
        sleep 10  # Wait for MySQL to be healthy
        go build -o bin/api cmd/api/main.go
        ./bin/api &
        sleep 5  # Wait for API to start

    - name: Wait for API health
      run: |
        for i in {1..30}; do
          if curl -s http://localhost:8081/health | grep -q "ok"; then
            echo "API is healthy"
            exit 0
          fi
          echo "Waiting for API... ($i/30)"
          sleep 2
        done
        echo "API failed to start"
        exit 1

    - name: Run load test
      run: |
        echo "Running load test with: users=$LOAD_TEST_USERS, spawn_rate=$LOAD_TEST_SPAWN_RATE, duration=$LOAD_TEST_DURATION"

        locust -f tests/load/locustfile.py \
          --host=http://localhost:8081 \
          --users $LOAD_TEST_USERS \
          --spawn-rate $LOAD_TEST_SPAWN_RATE \
          --run-time $LOAD_TEST_DURATION \
          --headless \
          --html=load-test-report.html \
          --csv=load-test-results

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: load-test-results
        path: |
          load-test-report.html
          load-test-results*.csv

    - name: Check failure rate
      run: |
        # Extract failure rate from CSV
        if [ -f load-test-results_stats.csv ]; then
          FAIL_RATE=$(tail -1 load-test-results_stats.csv | cut -d',' -f5)
          echo "Failure rate: ${FAIL_RATE}%"
          # Fail if error rate > 1%
          if [ $(echo "$FAIL_RATE > 1" | bc -l) -eq 1 ]; then
            echo "Error rate too high: ${FAIL_RATE}%"
            exit 1
          fi
        fi

    - name: Cleanup
      if: always()
      run: |
        pkill -f "./bin/api" || true
        docker compose down -v || true
